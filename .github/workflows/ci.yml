name: Workflow

on:
  pull_request:
    types: [ opened, synchronize, reopened, edited ]

env:
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

jobs:
  typecheck:
    name: Run types check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install
      - run: npm run typecheck

  eslint:
    name: Run ESLint
    runs-on: ubuntu-latest
    needs: typecheck
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: '20'
      - run: npm install
      - run: npm run lint

  deploy-preview:
    name: Deploy Preview to Vercel
    runs-on: ubuntu-latest
    needs: eslint
    outputs:
      preview_url: ${{ steps.deploy.outputs.preview_url }}
    steps:
      - uses: actions/checkout@v4
      - name: Install Vercel CLI
        run: npm install --global vercel@latest
      - name: Pull Vercel Environment Information
        run: vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
      - name: Build Project Artifacts
        run: vercel build --token=${{ secrets.VERCEL_TOKEN }}
      - name: Deploy Project Artifacts to Vercel
        id: deploy
        run: |
          URL=$(vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }} | grep -Po '(?<=https://)[^ ]*.vercel.app')
          echo "::set-output name=preview_url::https://$URL"
          echo "Deployed Preview URL: https://$URL"

  add-preview-url-to-comment:
    name: Comment Preview URL on PR
    runs-on: ubuntu-latest
    needs: deploy-preview
    permissions:
      pull-requests: write
    steps:
      - name: Comment Preview URL on PR
        uses: actions/github-script@v5
        with:
          script: |
            const previewUrl = '${{ needs.Deploy-Preview.outputs.preview_url }}';
            const message = `
            ðŸš€ **Deployed Preview URL** ðŸš€
            **ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð²ÐµÑ€ÑÐ¸Ñ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð° Ð½Ð° Vercel!** Ð’Ð¾Ñ‚ ÑÑÑ‹Ð»ÐºÐ° Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¹:
            
            **ðŸ”— [ÐŸÑ€ÐµÐ²ÑŒÑŽ](${previewUrl})**
            
            ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ñ€ÐµÐ²ÑŒÑŽ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»Ð¸ÑÐ½Ð¸ÐµÐ¼ Ð²Ð°ÑˆÐµÐ³Ð¾ Ð¿ÑƒÐ»Ð»-Ñ€ÐµÐºÐ²ÐµÑÑ‚Ð°, Ñ‡Ñ‚Ð¾Ð±Ñ‹ ÑƒÐ±ÐµÐ´Ð¸Ñ‚ÑŒÑÑ, Ñ‡Ñ‚Ð¾ Ð²ÑÐµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð¸Ñ€ÑƒÐµÑ‚ ÐºÐ°Ðº Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð°Ð³Ð°Ð»Ð¾ÑÑŒ. Ð’ ÑÐ»ÑƒÑ‡Ð°Ðµ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½Ð¾Ð²ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ð¸Ð»Ð¸ ÐµÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð·Ð°Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ, Ð½Ðµ ÑÑ‚ÐµÑÐ½ÑÐ¹Ñ‚ÐµÑÑŒ Ð¾ÑÑ‚Ð°Ð²Ð»ÑÑ‚ÑŒ Ð¸Ñ… Ð² ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÑÑ… Ð·Ð´ÐµÑÑŒ.`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });
